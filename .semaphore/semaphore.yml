version: v1.0
name: MyKickAssPipeline
agent:
  machine:
    type: a1-standard-4
    os_image: macos-xcode12
blocks:
  - name: Install deps
    task:
      env_vars:
        - name: LANG
          value: en_US.UTF-8
      prologue:
        commands:
          - checkout
          - cache restore
          - gem install bundler -v '2.1.4'
          - bundle install --path vendor/bundle
          - cache store
      jobs:
        - name: Bundle
          commands:
            - checkout
            - make bundle
    dependencies: []
  - name: Static Analysis
    task:
      env_vars:
        - name: LANG
          value: en_US.UTF-8
      prologue:
        commands:
          - checkout
          - cache restore
          - gem install bundler -v '2.1.4'
          - bundle install --path vendor/bundle
          - cache store
      jobs:
        - name: Rubocop
          commands:
            - checkout
            - make terminator
        - name: Lint
          commands:
            - checkout
            - make lint
    dependencies: []
  - name: Unit tests
    task:
      env_vars:
        - name: LANG
          value: en_US.UTF-8
      prologue:
        commands:
          - checkout
          - cache restore
          - gem install bundler -v '2.1.4'
          - bundle install --path vendor/bundle
          - cache store
      jobs:
        - name: RSpec
          commands:
            - checkout
            - make rspec
          parallelism: 10
    dependencies:
      - Install deps
      - Static Analysis
  - name: Acceptance test
    dependencies:
      - Unit tests
    task:
      jobs:
        - name: Cucumber
          commands:
            - checkout
            - make cucumber
          parallelism: 4
promotions:
  - name: 'Production deploy '
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: branch = 'master' AND result = 'passed'
  - name: Production deployment pipeline
    pipeline_file: pipeline_3.yml
